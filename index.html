<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Black Mountain College Chronology</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><polygon points='10,90 50,20 90,90' fill='%23000'/></svg>">
    <link rel="stylesheet" href="fonts/fonts.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,600;0,700;1,400&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg: #0d0d14;
            --card-bg: #151520;
            --text: #e8e8e8;
            --text-light: #aaa;
            --text-lighter: #666;
            --border: #2a2a2a;
            --accent: #ddd;
        }

        body {
            font-family: "Source Serif Pro", Georgia, serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
            font-size: 14px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Header */
        header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--border);
            gap: 1rem;
        }

        .logo {
            text-align: center;
        }

        .logo h1 {
            font-family: 'EB Garamond', Georgia, serif;
            font-size: 1.6rem;
            font-weight: 400;
            letter-spacing: 0.3em;
            text-transform: uppercase;
        }

        .logo .subtitle {
            font-family: 'EB Garamond', Georgia, serif;
            color: rgba(255,255,255,0.5);
            font-size: 0.9rem;
            font-style: italic;
            margin-top: 0.2rem;
        }

        /* Date picker */
        .date-picker {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        input[type="date"] {
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text);
            font-family: inherit;
        }

        button {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            background: var(--accent);
            color: var(--bg);
            border: none;
            cursor: pointer;
            font-family: inherit;
        }

        button:hover { opacity: 0.85; }

        /* Date display */
        .date-banner {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
        }

        .date-main {
            font-size: 1.4rem;
            margin-bottom: 0.25rem;
        }

        .date-day {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .year-context {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
            font-size: 0.8rem;
            color: var(--text-light);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
        }

        .context-item strong {
            color: var(--text);
        }

        /* Ridgeline Plot */
        .ridgeline-container {
            background: var(--card-bg);
            border: 1px solid var(--border);
            margin: 0;
            margin-bottom: 1.5rem;
            padding: 1rem;
            position: relative;
            overflow: visible;
        }

        .ridgeline-svg {
            width: 100%;
            height: 320px;
            display: block;
        }

        .ridgeline-area {
            transition: opacity 0.15s;
        }

        .ridgeline-area:hover {
            opacity: 0.9 !important;
        }

        .ridgeline-cursor-row {
            position: relative;
            height: 10px;
            margin: 0;
        }

        .ridgeline-cursor-triangle {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 8px solid #fff;
            transform: translateX(-6px);
            transition: left 0.15s ease-out;
            top: 0;
        }

        .ridgeline-legend {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            margin-top: 0.5rem;
            flex-wrap: wrap;
            padding: 0 1.5rem;
        }

        .ridgeline-legend-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.6rem;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .ridgeline-legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 1px;
        }

        .ridgeline-year-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.5rem;
            color: rgba(255,255,255,0.4);
            padding: 0;
            margin-top: 2px;
        }

        .ridgeline-year-labels span {
            flex: 1;
            text-align: center;
        }

        .ridgeline-year-labels span:first-child {
            text-align: left;
        }

        .ridgeline-year-labels span:last-child {
            text-align: right;
        }

        .ridgeline-tooltip {
            position: absolute;
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 0.4rem 0.6rem;
            font-size: 0.65rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
            z-index: 10;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        .ridgeline-tooltip.visible {
            opacity: 1;
        }

        /* Widget Grid - Masonry layout */
        .widget-grid {
            column-count: 3;
            column-gap: 1rem;
        }

        @media (max-width: 900px) {
            .widget-grid {
                column-count: 2;
            }
        }

        @media (max-width: 600px) {
            .widget-grid {
                column-count: 1;
            }
        }

        .widget {
            background: var(--card-bg);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            break-inside: avoid;
            margin-bottom: 1rem;
        }

        .widget-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .widget-title {
            font-size: 0.65rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-lighter);
        }

        .widget-count {
            font-size: 0.7rem;
            color: var(--text-lighter);
        }

        .widget-content {
            padding: 0.75rem 1rem;
            flex: 1;
        }

        /* Full width widgets */
        .widget.full-width {
            grid-column: 1 / -1;
        }

        .widget.half-width {
            grid-column: span 2;
        }

        /* Weather widget */
        .weather-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            text-align: center;
        }

        .weather-item {
            padding: 0.5rem;
        }

        .weather-value {
            font-size: 1.1rem;
            margin-bottom: 0.15rem;
        }

        .weather-label {
            font-size: 0.65rem;
            color: var(--text-lighter);
            text-transform: uppercase;
        }

        .weather-desc {
            grid-column: 1 / -1;
            text-align: left;
            color: var(--text-light);
            font-style: italic;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border);
            margin-top: 0.25rem;
        }

        /* Dropdown/Accordion */
        .dropdown {
            border: 1px solid var(--border);
            margin-bottom: 0.5rem;
        }

        .dropdown:last-child {
            margin-bottom: 0;
        }

        .dropdown-header {
            padding: 0.6rem 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background: var(--bg);
            user-select: none;
        }

        .dropdown-header:hover {
            background: var(--border);
        }

        .dropdown-title {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dropdown-count {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .dropdown-arrow {
            font-size: 0.7rem;
            color: var(--text-lighter);
            transition: transform 0.2s;
        }

        .dropdown.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-content {
            display: none;
            padding: 0.75rem;
            border-top: 1px solid var(--border);
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.8rem;
            line-height: 1.6;
            color: var(--text-light);
        }

        .dropdown.open .dropdown-content {
            display: block;
        }

        /* People list */
        .people-list {
            column-count: 2;
            column-gap: 1rem;
        }

        .person-item {
            break-inside: avoid;
            padding: 0.15rem 0;
        }

        .person-focus {
            font-size: 0.7rem;
            color: var(--text-lighter);
        }

        /* Courses */
        .courses-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
        }

        .course-chip {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            background: var(--bg);
            border: 1px solid var(--border);
        }

        .course-instructor {
            color: var(--text-lighter);
        }

        /* Events */
        .event-group {
            margin-bottom: 1rem;
        }

        .event-group:last-child {
            margin-bottom: 0;
        }

        .event-group-title {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-lighter);
            margin-bottom: 0.4rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid var(--border);
        }

        .event-item {
            padding: 0.4rem 0;
            border-bottom: 1px dotted var(--border);
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-text {
            font-size: 0.85rem;
        }

        .event-meta {
            font-size: 0.7rem;
            color: var(--text-lighter);
            margin-top: 0.15rem;
        }

        .event-source {
            color: var(--text-lighter);
            font-size: 0.65rem;
            display: block;
            margin-top: 0.2rem;
        }

        .event-source i {
            font-style: italic;
        }

        .certainty-low {
            color: var(--text-lighter);
            font-style: italic;
        }

        .event-people {
            color: var(--text-light);
        }

        .event-quote {
            font-style: italic;
            color: var(--text-light);
            font-size: 0.8rem;
            margin: 0.25rem 0;
            padding-left: 0.6rem;
            border-left: 2px solid var(--border);
        }

        /* World/USA events */
        .context-event {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .context-event:last-child {
            border-bottom: none;
        }

        .context-event-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .context-event-desc {
            font-size: 0.8rem;
            color: var(--text-light);
            line-height: 1.5;
            margin-bottom: 0.25rem;
        }

        .context-event-meta {
            font-size: 0.7rem;
            color: var(--text-lighter);
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .context-tag {
            font-size: 0.6rem;
            padding: 0.15rem 0.35rem;
            background: var(--bg);
            border: 1px solid var(--border);
            text-transform: uppercase;
            color: var(--text-lighter);
        }

        .context-tag.politics { border-color: #c44; color: #c44; }
        .context-tag.culture { border-color: #48a; color: #48a; }
        .context-tag.war { border-color: #a44; color: #a44; }
        .context-tag.economy { border-color: #4a4; color: #4a4; }
        .context-tag.science { border-color: #84a; color: #84a; }
        .context-tag.sports { border-color: #a84; color: #a84; }
        .context-tag.military { border-color: #a66; color: #a66; }
        .context-tag.civil_rights { border-color: #6a8; color: #6a8; }
        .context-tag.local { border-color: #8a6; color: #8a6; }

        /* Category badges for national events */
        .category-badge {
            font-size: 0.55rem;
            padding: 0.1rem 0.3rem;
            text-transform: uppercase;
            margin-right: 0.3rem;
            border-radius: 2px;
            font-weight: 600;
        }
        .category-badge.congress { background: #1a2a3a; color: #6af; border: 1px solid #6af; }
        .category-badge.asheville { background: #2a1a2a; color: #a6f; border: 1px solid #a6f; }
        .category-badge.north_carolina { background: #2a2a1a; color: #ca6; border: 1px solid #ca6; }
        .category-badge.national { background: #1a1a2a; color: #88c; border: 1px solid #88c; }
        .category-badge.nyt { background: #1a1a1a; color: #999; border: 1px solid #666; }

        .event-link {
            color: var(--text);
            text-decoration: none;
            border-bottom: 1px dotted var(--text-lighter);
        }
        .event-link:hover {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .culture-type.nyt {
            background: #1a1a1a;
            color: #999;
            border: 1px solid #666;
        }

        /* Culture widget */
        .culture-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .culture-item:last-child {
            border-bottom: none;
        }

        .culture-type {
            font-size: 0.6rem;
            padding: 0.15rem 0.35rem;
            text-transform: uppercase;
            margin-right: 0.4rem;
            display: inline-block;
        }

        .culture-type.film { background: #2a1a1a; color: #e88; border: 1px solid #e88; }
        .culture-type.book { background: #1a2a1a; color: #8c8; border: 1px solid #8c8; }
        .culture-type.theater { background: #2a1a2a; color: #c8c; border: 1px solid #c8c; }
        .culture-type.concert { background: #1a1a2a; color: #88e; border: 1px solid #88e; }
        .culture-type.art { background: #2a2a1a; color: #cc8; border: 1px solid #cc8; }

        /* NY Times headlines */
        .nyt-headline {
            padding: 0.4rem 0;
            border-bottom: 1px solid var(--border);
        }

        .nyt-headline:last-child {
            border-bottom: none;
        }

        .nyt-headline-text {
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .nyt-headline-section {
            font-size: 0.65rem;
            color: var(--text-lighter);
            margin-top: 0.2rem;
            text-transform: uppercase;
        }

        .culture-title {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .culture-creator {
            font-size: 0.8rem;
            color: var(--text-light);
            font-style: italic;
        }

        .culture-desc {
            font-size: 0.75rem;
            color: var(--text-lighter);
            margin-top: 0.2rem;
            line-height: 1.4;
        }

        .culture-duration {
            font-size: 0.7rem;
            color: var(--text-lighter);
            font-style: italic;
        }

        .event-duration {
            font-size: 0.6rem;
            padding: 0.1rem 0.3rem;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text-lighter);
        }

        .event-date {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--accent);
            margin-right: 0.4rem;
        }

        .no-events {
            color: var(--text-lighter);
            font-style: italic;
            font-size: 0.8rem;
            padding: 0.5rem 0;
        }

        /* Radio */
        .song-item {
            display: flex;
            gap: 0.6rem;
            padding: 0.35rem 0;
            border-bottom: 1px dotted var(--border);
            align-items: baseline;
        }

        .song-item:last-child {
            border-bottom: none;
        }

        .song-prob {
            font-size: 0.7rem;
            color: var(--text-lighter);
            min-width: 28px;
        }

        .song-info {
            flex: 1;
        }

        .song-title {
            font-size: 0.85rem;
        }

        .song-artist {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-lighter);
        }

        .results { display: none; }
        .results.visible { display: block; }

        /* Footer */
        footer {
            margin-top: 2rem;
            padding: 2rem 0;
            border-top: 1px solid var(--border);
            font-size: 0.6rem;
            letter-spacing: 0.2em;
            color: rgba(255,255,255,0.2);
            text-align: center;
        }

        .footer-sources {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.65rem;
            line-height: 1.6;
        }

        .footer-sources i {
            font-style: italic;
        }

        footer a {
            color: var(--text-light);
            text-decoration: none;
        }

        /* Mobile */
        @media (max-width: 600px) {
            .weather-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .people-list {
                column-count: 1;
            }
            header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* Contact Widget */
        .contact-desc {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 0.75rem;
        }

        .contact-form {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .contact-input, .contact-textarea {
            padding: 0.6rem 0.8rem;
            font-size: 0.85rem;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            font-family: inherit;
        }

        .contact-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .contact-hp {
            position: absolute;
            left: -9999px;
            opacity: 0;
            height: 0;
            width: 0;
        }

        .contact-submit {
            align-self: flex-start;
            padding: 0.6rem 1.2rem;
            font-size: 0.85rem;
            background: var(--accent);
            color: var(--bg);
            border: none;
            cursor: pointer;
            font-family: inherit;
        }

        .contact-submit:hover {
            opacity: 0.85;
        }

        .contact-status {
            font-size: 0.8rem;
            padding: 0.5rem 0;
        }

        .contact-status.success {
            color: #4a4;
        }

        .contact-status.error {
            color: #a44;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <h1>Black Mountain College Chronology</h1>
                <p class="subtitle">Daily Archive · 1933–1957</p>
            </div>
            <div class="date-picker">
                <input type="date" id="date-picker" min="1933-01-01" max="1957-12-31" value="1948-04-01">
                <button onclick="search()">Go</button>
            </div>
        </header>

        <div class="loading" id="loading">Loading archives...</div>

        <div class="results" id="results">
            <div class="date-banner">
                <div class="date-main" id="date-main"></div>
                <div class="date-day" id="date-day"></div>
                <div class="year-context" id="year-context"></div>
            </div>

            <!-- Ridgeline Plot -->
            <div class="ridgeline-container" id="ridgeline-container">
                <svg class="ridgeline-svg" id="ridgeline-svg" preserveAspectRatio="none"></svg>
                <div class="ridgeline-cursor-row">
                    <div class="ridgeline-cursor-triangle" id="ridgeline-cursor"></div>
                </div>
                <div class="ridgeline-year-labels" id="ridgeline-years"></div>
                <div class="ridgeline-legend" id="ridgeline-legend"></div>
                <div class="ridgeline-tooltip" id="ridgeline-tooltip"></div>
            </div>

            <div class="widget-grid">
                <!-- Weather -->
                <div class="widget" id="weather-widget">
                    <div class="widget-header">
                        <span class="widget-title">Weather</span>
                    </div>
                    <div class="widget-content">
                        <div class="weather-grid" id="weather-content"></div>
                    </div>
                </div>

                <!-- People -->
                <div class="widget" id="people-widget">
                    <div class="widget-header">
                        <span class="widget-title">People at BMC</span>
                        <span class="widget-count" id="people-total"></span>
                    </div>
                    <div class="widget-content" id="people-content"></div>
                </div>

                <!-- Courses -->
                <div class="widget" id="courses-widget">
                    <div class="widget-header">
                        <span class="widget-title">Courses</span>
                        <span class="widget-count" id="courses-count"></span>
                    </div>
                    <div class="widget-content" id="courses-content"></div>
                </div>

                <!-- Radio -->
                <div class="widget" id="radio-widget">
                    <div class="widget-header">
                        <span class="widget-title">On the Radio</span>
                    </div>
                    <div class="widget-content" id="radio-content"></div>
                </div>

                <!-- BMC Events -->
                <div class="widget half-width" id="events-widget">
                    <div class="widget-header">
                        <span class="widget-title">Events at BMC</span>
                        <span class="widget-count" id="events-count"></span>
                    </div>
                    <div class="widget-content" id="events-content"></div>
                </div>

                <!-- Culture -->
                <div class="widget" id="culture-widget">
                    <div class="widget-header">
                        <span class="widget-title">Culture</span>
                        <span class="widget-count" id="culture-count"></span>
                    </div>
                    <div class="widget-content" id="culture-content"></div>
                </div>

                <!-- National Events (Asheville, NC, Congress, National) -->
                <div class="widget" id="national-widget">
                    <div class="widget-header">
                        <span class="widget-title">National</span>
                        <span class="widget-count" id="national-count"></span>
                    </div>
                    <div class="widget-content" id="national-content"></div>
                </div>

                <!-- International Events -->
                <div class="widget" id="world-widget">
                    <div class="widget-header">
                        <span class="widget-title">International</span>
                        <span class="widget-count" id="world-count"></span>
                    </div>
                    <div class="widget-content" id="world-content"></div>
                </div>

                <!-- Contact Widget -->
                <div class="widget" id="contact-widget">
                    <div class="widget-header">
                        <span class="widget-title">Submit a Correction</span>
                    </div>
                    <div class="widget-content">
                        <p class="contact-desc">Help improve this chronology with corrections or additional sources.</p>
                        <form id="contact-form" class="contact-form">
                            <input type="text" name="name" placeholder="Your name" required class="contact-input">
                            <input type="email" name="email" placeholder="Your email" required class="contact-input">
                            <textarea name="message" placeholder="Your correction or information..." required class="contact-textarea"></textarea>
                            <button type="submit" class="contact-submit">Send Message</button>
                            <div id="contact-status" class="contact-status"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <a href="https://rbmirc.github.io/essays">Retcon Black Mountain</a><br>
            <span class="footer-sources">
                Sources:
                DUBERMAN, Martin. <i>Black Mountain: An Exploration in Community</i>. New York: E.P. Dutton, 1972 ·
                <a href="https://collection.ashevilleart.org/objects-1/portfolio?query=Portfolios%20%3D%20%22579%22" target="_blank">Dreier Collection</a>, Asheville Art Museum (369 docs) ·
                HARRIS, Mary Emma. <i>The Arts at Black Mountain College</i>. MIT Press, 1987. Papers at Appalachian State University, Boone, NC ·
                Custom database with documents from the Western Regional Archives in Asheville, the Josef & Anni Albers Foundation in Bethany, Stanford Archives Collection, New York Public Library, and other online resources ·
                <a href="https://open-meteo.com/" target="_blank">Open-Meteo</a> Historical Weather API ·
                <a href="https://www.billboard.com/charts/" target="_blank">Billboard</a> Hot 100 Archives ·
                <a href="https://developer.nytimes.com/" target="_blank">NY Times</a> Archive API
                <br><em>This is a personal project and may contain errors.</em>
            </span>
        </footer>
    </div>

    <script>
        let archiveData = null;
        let weatherData = null;
        let radioData = null;
        let coursesData = null;
        let contextData = null;
        let peopleIndex = null;
        let verifiedData = null;
        let cultureData = null;
        let chronologyData = null;
        let nationalData = null;
        let bmcTimelineData = null;
        let nytCultureData = null;
        let nytNationalData = null;
        let nytInternationalData = null;

        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        const weatherCodes = {
            0: 'Clear sky', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast',
            45: 'Fog', 48: 'Rime fog', 51: 'Light drizzle', 53: 'Drizzle', 55: 'Dense drizzle',
            61: 'Light rain', 63: 'Rain', 65: 'Heavy rain', 71: 'Light snow', 73: 'Snow', 75: 'Heavy snow',
            80: 'Rain showers', 81: 'Showers', 82: 'Heavy showers', 95: 'Thunderstorm'
        };

        // Ridgeline plot data and rendering
        let ridgelineData = null;

        function computeRidgelineData() {
            // Compute people counts per year by category
            const categories = {
                faculty: { label: 'Faculty', data: [] },
                students: { label: 'Students', data: [] },
                staff: { label: 'Staff', data: [] },
                guests: { label: 'Guests', data: [] },
                summerFaculty: { label: 'Summer Faculty', data: [] },
                summerStudents: { label: 'Summer Students', data: [] }
            };

            for (let year = 1933; year <= 1957; year++) {
                const counts = { faculty: 0, students: 0, staff: 0, guests: 0, summerFaculty: 0, summerStudents: 0 };

                for (const [name, data] of Object.entries(peopleIndex)) {
                    const startYear = data.start_year || 9999;
                    const endYear = data.end_year || 0;

                    if (year >= startYear && year <= endYear) {
                        const role = (data.role || '').toLowerCase();
                        // Check for summer institute first (priority)
                        if (role.includes('summer') && role.includes('faculty')) {
                            counts.summerFaculty++;
                        } else if (role.includes('summer') && role.includes('student')) {
                            counts.summerStudents++;
                        } else if (role.includes('summer')) {
                            counts.summerFaculty++; // Default summer to faculty
                        } else if (role.includes('faculty') || role.includes('admin')) {
                            counts.faculty++;
                        } else if (role.includes('student')) {
                            counts.students++;
                        } else if (role.includes('staff')) {
                            counts.staff++;
                        } else if (role.includes('guest')) {
                            counts.guests++;
                        }
                    }
                }

                categories.faculty.data.push({ year, count: counts.faculty });
                categories.students.data.push({ year, count: counts.students });
                categories.staff.data.push({ year, count: counts.staff });
                categories.guests.data.push({ year, count: counts.guests });
                categories.summerFaculty.data.push({ year, count: counts.summerFaculty });
                categories.summerStudents.data.push({ year, count: counts.summerStudents });
            }

            return categories;
        }

        function renderRidgeline() {
            if (!peopleIndex) return;

            ridgelineData = computeRidgelineData();
            const svg = document.getElementById('ridgeline-svg');
            const container = document.getElementById('ridgeline-container');
            const legend = document.getElementById('ridgeline-legend');

            // Use fixed viewBox coordinates (will scale to SVG size)
            const width = 1000;  // Fixed coordinate system
            const height = 320;
            const padding = { top: 10, right: 0, bottom: 5, left: 0 };
            const plotWidth = width;
            const plotHeight = height - padding.top - padding.bottom;

            // Set viewBox for proper scaling
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

            const numYears = 25; // 1933 to 1957 inclusive

            // Calculate total per year for stacked chart
            const totals = [];
            for (let i = 0; i < numYears; i++) {
                totals.push(
                    ridgelineData.students.data[i].count +
                    ridgelineData.faculty.data[i].count +
                    ridgelineData.staff.data[i].count +
                    ridgelineData.guests.data[i].count
                );
            }
            const maxTotal = Math.max(...totals);

            // Simple line chart for each category - not stacked, just overlapping lines
            const categories = [
                { key: 'students', color: '#4ecdc4', label: 'Students' },
                { key: 'faculty', color: '#a86bff', label: 'Faculty' }
            ];

            const baseLineY = height - padding.bottom;
            let svgContent = '';

            // Find individual max for each to scale properly
            const maxStudents = Math.max(...ridgelineData.students.data.map(d => d.count));
            const maxFaculty = Math.max(...ridgelineData.faculty.data.map(d => d.count));
            const maxStaff = Math.max(...ridgelineData.staff.data.map(d => d.count));
            const maxGuests = Math.max(...ridgelineData.guests.data.map(d => d.count));
            const maxSummerFaculty = Math.max(...ridgelineData.summerFaculty.data.map(d => d.count));
            const maxSummerStudents = Math.max(...ridgelineData.summerStudents.data.map(d => d.count));
            const globalMax = Math.max(maxStudents, maxFaculty, maxStaff, maxGuests, maxSummerFaculty, maxSummerStudents);

            // Grayscale palette - adapts to dark mode
            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const colors = isDark ? {
                students: '#666666',      // Light gray (back)
                staff: '#888888',         // Lighter gray
                guests: '#aaaaaa',        // Even lighter
                faculty: '#cccccc',       // Near white
                summerFaculty: '#ffffff', // White - dashed
                summerStudents: '#ffffff' // White - dotted
            } : {
                students: '#999999',      // Medium gray (back)
                staff: '#666666',         // Dark gray
                guests: '#444444',        // Darker gray
                faculty: '#222222',       // Near black
                summerFaculty: '#000000', // Black - dashed
                summerStudents: '#000000' // Black - dotted
            };

            // Gradient definitions
            svgContent += `
                <defs>
                    <linearGradient id="gradStudents" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:${colors.students};stop-opacity:0.7"/>
                        <stop offset="100%" style="stop-color:${colors.students};stop-opacity:0.05"/>
                    </linearGradient>
                    <linearGradient id="gradFaculty" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:${colors.faculty};stop-opacity:0.7"/>
                        <stop offset="100%" style="stop-color:${colors.faculty};stop-opacity:0.05"/>
                    </linearGradient>
                    <linearGradient id="gradStaff" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:${colors.staff};stop-opacity:0.7"/>
                        <stop offset="100%" style="stop-color:${colors.staff};stop-opacity:0.05"/>
                    </linearGradient>
                    <linearGradient id="gradGuests" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:${colors.guests};stop-opacity:0.7"/>
                        <stop offset="100%" style="stop-color:${colors.guests};stop-opacity:0.05"/>
                    </linearGradient>
                </defs>
            `;

            // White background
            // Background handled by container CSS (supports dark mode)

            // Helper function to draw area + line (uses globalMax for proportional scaling)
            function drawCategory(data, gradId, color, strokeWidth) {
                // Area with gradient
                let areaPath = `M ${padding.left} ${baseLineY}`;
                data.forEach((d, i) => {
                    const x = padding.left + ((i + 0.5) / numYears) * plotWidth;
                    const h = globalMax > 0 ? (d.count / globalMax) * plotHeight * 0.85 : 0;
                    areaPath += ` L ${x} ${baseLineY - h}`;
                });
                areaPath += ` L ${plotWidth} ${baseLineY} Z`;
                svgContent += `<path d="${areaPath}" fill="url(#${gradId})"/>`;

                // Line on top
                if (data[0].count > 0) {
                    let linePath = `M ${padding.left + (0.5 / numYears) * plotWidth} ${baseLineY - (data[0].count / globalMax) * plotHeight * 0.85}`;
                    data.forEach((d, i) => {
                        if (i === 0) return;
                        const x = padding.left + ((i + 0.5) / numYears) * plotWidth;
                        const h = globalMax > 0 ? (d.count / globalMax) * plotHeight * 0.85 : 0;
                        linePath += ` L ${x} ${baseLineY - h}`;
                    });
                    svgContent += `<path d="${linePath}" fill="none" stroke="${color}" stroke-width="${strokeWidth}"/>`;
                }
            }

            // Draw summer lines at summer position (July-Sept) with dashed/dotted style
            function drawSummerLine(data, color, dashArray, strokeWidth) {
                const yearWidth = plotWidth / numYears;
                const summerCenter = 0.625; // July-Aug center

                data.forEach((d, i) => {
                    if (d.count === 0) return;
                    const yearStart = padding.left + (i / numYears) * plotWidth;
                    const x = yearStart + summerCenter * yearWidth;
                    const h = globalMax > 0 ? (d.count / globalMax) * plotHeight * 0.85 : 0;

                    // Draw vertical line at summer position
                    svgContent += `<line x1="${x}" y1="${baseLineY}" x2="${x}" y2="${baseLineY - h}"
                        stroke="${color}" stroke-width="${strokeWidth}" stroke-dasharray="${dashArray}"/>`;
                });
            }

            // Draw all categories (order: back to front)
            drawCategory(ridgelineData.students.data, 'gradStudents', colors.students, 2);
            drawCategory(ridgelineData.staff.data, 'gradStaff', colors.staff, 1.5);
            drawCategory(ridgelineData.guests.data, 'gradGuests', colors.guests, 1.5);
            drawCategory(ridgelineData.faculty.data, 'gradFaculty', colors.faculty, 2);

            // Draw summer lines on top: dashed for faculty, dotted for students
            drawSummerLine(ridgelineData.summerFaculty.data, colors.summerFaculty, '8,4', 2);
            drawSummerLine(ridgelineData.summerStudents.data, colors.summerStudents, '2,3', 2);

            svg.innerHTML = svgContent;

            // Render legend with gradient samples and line styles
            legend.innerHTML = `
                <div class="ridgeline-legend-item">
                    <svg width="24" height="12">
                        <defs><linearGradient id="legStudents" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:${colors.students};stop-opacity:0.7"/><stop offset="100%" style="stop-color:${colors.students};stop-opacity:0.1"/></linearGradient></defs>
                        <rect x="0" y="0" width="24" height="12" fill="url(#legStudents)"/>
                        <line x1="0" y1="2" x2="24" y2="2" stroke="${colors.students}" stroke-width="2"/>
                    </svg>
                    <span>Students</span>
                </div>
                <div class="ridgeline-legend-item">
                    <svg width="24" height="12">
                        <defs><linearGradient id="legFaculty" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:${colors.faculty};stop-opacity:0.7"/><stop offset="100%" style="stop-color:${colors.faculty};stop-opacity:0.1"/></linearGradient></defs>
                        <rect x="0" y="0" width="24" height="12" fill="url(#legFaculty)"/>
                        <line x1="0" y1="2" x2="24" y2="2" stroke="${colors.faculty}" stroke-width="2"/>
                    </svg>
                    <span>Faculty</span>
                </div>
                <div class="ridgeline-legend-item">
                    <svg width="24" height="12">
                        <line x1="0" y1="6" x2="24" y2="6" stroke="${colors.summerFaculty}" stroke-width="2" stroke-dasharray="8,4"/>
                    </svg>
                    <span>Summer Faculty</span>
                </div>
                <div class="ridgeline-legend-item">
                    <svg width="24" height="12">
                        <line x1="0" y1="6" x2="24" y2="6" stroke="${colors.summerStudents}" stroke-width="2" stroke-dasharray="2,3"/>
                    </svg>
                    <span>Summer Students</span>
                </div>
                <div class="ridgeline-legend-item">
                    <svg width="24" height="12">
                        <defs><linearGradient id="legStaff" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:${colors.staff};stop-opacity:0.7"/><stop offset="100%" style="stop-color:${colors.staff};stop-opacity:0.1"/></linearGradient></defs>
                        <rect x="0" y="0" width="24" height="12" fill="url(#legStaff)"/>
                        <line x1="0" y1="2" x2="24" y2="2" stroke="${colors.staff}" stroke-width="2"/>
                    </svg>
                    <span>Staff</span>
                </div>
                <div class="ridgeline-legend-item">
                    <svg width="24" height="12">
                        <defs><linearGradient id="legGuests" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:${colors.guests};stop-opacity:0.7"/><stop offset="100%" style="stop-color:${colors.guests};stop-opacity:0.1"/></linearGradient></defs>
                        <rect x="0" y="0" width="24" height="12" fill="url(#legGuests)"/>
                        <line x1="0" y1="2" x2="24" y2="2" stroke="${colors.guests}" stroke-width="2"/>
                    </svg>
                    <span>Guests</span>
                </div>
            `;

            // Render year labels - all years from 1933 to 1957
            const yearsEl = document.getElementById('ridgeline-years');
            let yearsHtml = '';
            for (let y = 1933; y <= 1957; y++) {
                yearsHtml += `<span>${y}</span>`;
            }
            yearsEl.innerHTML = yearsHtml;

            // Add hover interaction
            svg.addEventListener('mousemove', (e) => {
                const rect = svg.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const yearIndex = Math.floor((x / rect.width) * numYears);
                const year = 1933 + Math.max(0, Math.min(numYears - 1, yearIndex));

                const tooltip = document.getElementById('ridgeline-tooltip');
                const counts = {};
                Object.entries(ridgelineData).forEach(([key, cat]) => {
                    const d = cat.data.find(d => d.year === year);
                    if (d) counts[cat.label] = d.count;
                });

                tooltip.innerHTML = `<strong>${year}</strong><br>` +
                    Object.entries(counts).map(([k, v]) => `${k}: ${v}`).join('<br>');
                tooltip.style.left = `${Math.min(e.clientX - rect.left + 10, rect.width - 120)}px`;
                tooltip.style.top = `${e.clientY - rect.top - 60}px`;
                tooltip.classList.add('visible');
            });

            svg.addEventListener('mouseleave', () => {
                document.getElementById('ridgeline-tooltip').classList.remove('visible');
            });

            // Make SVG clickable to change date
            svg.style.cursor = 'pointer';
            svg.addEventListener('click', (e) => {
                const rect = svg.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const yearIndex = Math.floor((x / rect.width) * numYears);
                const year = 1933 + Math.max(0, Math.min(numYears - 1, yearIndex));

                // Set date picker to July 1 of clicked year
                document.getElementById('date-picker').value = `${year}-07-01`;
                search();
            });
        }

        function updateRidgelineCursor(dateValue) {
            const cursor = document.getElementById('ridgeline-cursor');
            if (!cursor) return;

            const year = parseInt(dateValue.substring(0, 4));
            const month = parseInt(dateValue.substring(5, 7));
            const day = parseInt(dateValue.substring(8, 10));

            // Calculate precise position - data points are centered in year segments
            // Each year segment is 1/25 of width, data point at center (+0.5)
            const yearIndex = year - 1933;
            const yearFraction = (month - 1) / 12 + day / 365;
            const yearPos = (yearIndex + 0.5 + yearFraction) / 25;

            // Position as percentage of container width
            cursor.style.left = `${Math.min(Math.max(yearPos * 100, 0), 100)}%`;
        }

        async function loadData() {
            try {
                const [archiveRes, weatherRes, radioRes, coursesRes, contextRes, peopleRes, verifiedRes, cultureRes, chronoRes, nationalRes, bmcTimelineRes, nytCultureRes, nytNationalRes, nytIntlRes] = await Promise.all([
                    fetch('bmc_complete_archive.json'),
                    fetch('bmc_weather.json'),
                    fetch('bmc_radio_archive_1933-1957.json'),
                    fetch('bmc_courses_by_year.json'),
                    fetch('bmc_yearly_context.json'),
                    fetch('bmc_people_index.json'),
                    fetch('bmc_verified_faculty_courses.json'),
                    fetch('bmc_culture_1933-1957.json'),
                    fetch('bmc_chronology_precise.json'),
                    fetch('bmc_national_events.json'),
                    fetch('bmc_timeline.json'),
                    fetch('nyt_culture.json').catch(() => ({ ok: false })),
                    fetch('nyt_national.json').catch(() => ({ ok: false })),
                    fetch('nyt_international.json').catch(() => ({ ok: false }))
                ]);

                archiveData = await archiveRes.json();
                weatherData = await weatherRes.json();
                radioData = await radioRes.json();
                coursesData = await coursesRes.json();
                contextData = await contextRes.json();
                peopleIndex = await peopleRes.json();
                cultureData = await cultureRes.json();
                verifiedData = await verifiedRes.json();
                chronologyData = await chronoRes.json();
                nationalData = await nationalRes.json();
                bmcTimelineData = await bmcTimelineRes.json();
                if (nytCultureRes.ok) nytCultureData = await nytCultureRes.json();
                if (nytNationalRes.ok) nytNationalData = await nytNationalRes.json();
                if (nytIntlRes.ok) nytInternationalData = await nytIntlRes.json();

                document.getElementById('loading').style.display = 'none';
                renderRidgeline();
                search();
            } catch (err) {
                document.getElementById('loading').textContent = 'Error: ' + err.message;
                console.error('Load error:', err);
            }
        }

        function search() {
            const dateValue = document.getElementById('date-picker').value;
            if (!archiveData || !dateValue) return;

            const [year, month, day] = dateValue.split('-');
            const dateObj = new Date(dateValue);

            // Date display
            document.getElementById('date-main').textContent = `${monthNames[dateObj.getMonth()]} ${parseInt(day)}, ${year}`;
            document.getElementById('date-day').textContent = dayNames[dateObj.getDay()];

            // Context
            renderContext(year, dateValue);

            // Widgets
            renderWeather(year, month, day);
            renderPeople(year, dateValue);
            renderCourses(year, month);
            renderEvents(year, dateValue);
            renderCulture(year, month, day);
            renderNational(year, dateValue);
            renderWorld(year, dateValue);
            renderRadio(year, month, day);

            // Update ridgeline cursor position
            updateRidgelineCursor(dateValue);

            // Optimize widget layout - reorder by height for better masonry
            optimizeWidgetLayout();

            document.getElementById('results').classList.add('visible');
        }

        function optimizeWidgetLayout() {
            // Wait for DOM to update, then reorder widgets by height
            requestAnimationFrame(() => {
                const grid = document.querySelector('.widget-grid');
                if (!grid) return;

                const widgets = Array.from(grid.querySelectorAll('.widget'));

                // Get visible widgets with their heights
                const widgetData = widgets
                    .filter(w => w.style.display !== 'none')
                    .map(w => ({
                        el: w,
                        height: w.offsetHeight,
                        id: w.id
                    }));

                // Sort by height descending (tallest first works better with columns)
                widgetData.sort((a, b) => b.height - a.height);

                // Reorder in DOM
                widgetData.forEach(w => grid.appendChild(w.el));
            });
        }

        function renderContext(year, dateKey) {
            const el = document.getElementById('year-context');
            const selectedDate = new Date(dateKey);

            // Find BMC events active on this date
            const activeEvents = [];
            if (bmcTimelineData?.events) {
                for (const [startDateKey, evt] of Object.entries(bmcTimelineData.events)) {
                    const startDate = new Date(startDateKey);
                    const endDate = evt.end_date ? new Date(evt.end_date) : startDate;

                    // Event is active if selectedDate is between start and end
                    if (selectedDate >= startDate && selectedDate <= endDate) {
                        activeEvents.push({ ...evt, start_date: startDateKey });
                    }
                }
            }

            if (activeEvents.length === 0) {
                const ctx = contextData?.[year];
                if (ctx?.bmc_status) {
                    el.innerHTML = `<div class="context-item"><strong>BMC ${year}:</strong> ${esc(ctx.bmc_status)}</div>`;
                } else {
                    el.innerHTML = '';
                }
                return;
            }

            el.innerHTML = activeEvents.map(evt => {
                const startFormatted = formatEventDate(evt.start_date);
                let dateDisplay = `<span class="event-date">${startFormatted}</span>`;
                if (evt.end_date) {
                    const endFormatted = formatEventDate(evt.end_date);
                    const start = new Date(evt.start_date);
                    const end = new Date(evt.end_date);
                    const days = Math.round((end - start) / (1000 * 60 * 60 * 24));
                    let durationText = '';
                    if (days > 365) {
                        durationText = `${Math.round(days / 365 * 10) / 10} years`;
                    } else if (days > 30) {
                        durationText = `${Math.round(days / 30)} months`;
                    } else {
                        durationText = `${days} days`;
                    }
                    dateDisplay += ` <span class="event-duration">→ ${endFormatted} (${durationText})</span>`;
                }
                return `<div class="context-item">
                    <div><strong>BMC:</strong> ${dateDisplay} ${esc(evt.event)}</div>
                    ${evt.description ? `<div class="context-event-desc">${esc(evt.description)}</div>` : ''}
                    ${evt.source ? `<div class="event-source">${esc(evt.source)}</div>` : ''}
                </div>`;
            }).join('');
        }

        // Calculate sunrise/sunset for Black Mountain College (35.6°N, 82.3°W)
        function getSunTimes(year, month, day) {
            const lat = 35.6;
            const lng = -82.3;
            const date = new Date(year, month - 1, day);

            // Day of year
            const start = new Date(year, 0, 0);
            const diff = date - start;
            const dayOfYear = Math.floor(diff / (1000 * 60 * 60 * 24));

            // Solar calculations
            const zenith = 90.833;
            const D2R = Math.PI / 180;
            const R2D = 180 / Math.PI;

            // Approximate time
            const lngHour = lng / 15;
            const tRise = dayOfYear + ((6 - lngHour) / 24);
            const tSet = dayOfYear + ((18 - lngHour) / 24);

            // Sun's mean anomaly
            const MRise = (0.9856 * tRise) - 3.289;
            const MSet = (0.9856 * tSet) - 3.289;

            // Sun's true longitude
            function trueLong(M) {
                let L = M + (1.916 * Math.sin(M * D2R)) + (0.020 * Math.sin(2 * M * D2R)) + 282.634;
                while (L > 360) L -= 360;
                while (L < 0) L += 360;
                return L;
            }

            const LRise = trueLong(MRise);
            const LSet = trueLong(MSet);

            // Right ascension
            function rightAsc(L) {
                let RA = R2D * Math.atan(0.91764 * Math.tan(L * D2R));
                while (RA > 360) RA -= 360;
                while (RA < 0) RA += 360;
                const Lquad = Math.floor(L / 90) * 90;
                const RAquad = Math.floor(RA / 90) * 90;
                RA = RA + (Lquad - RAquad);
                return RA / 15;
            }

            const RARise = rightAsc(LRise);
            const RASet = rightAsc(LSet);

            // Sun's declination
            function sinDec(L) { return 0.39782 * Math.sin(L * D2R); }
            function cosDec(L) { return Math.cos(Math.asin(sinDec(L))); }

            // Hour angle
            function hourAngle(L, rise) {
                const cosH = (Math.cos(zenith * D2R) - (sinDec(L) * Math.sin(lat * D2R))) / (cosDec(L) * Math.cos(lat * D2R));
                if (cosH > 1 || cosH < -1) return null;
                let H = R2D * Math.acos(cosH);
                return rise ? (360 - H) / 15 : H / 15;
            }

            const HRise = hourAngle(LRise, true);
            const HSet = hourAngle(LSet, false);

            if (HRise === null || HSet === null) return { sunrise: '--:--', sunset: '--:--' };

            // Local time
            const TRise = HRise + RARise - (0.06571 * tRise) - 6.622;
            const TSet = HSet + RASet - (0.06571 * tSet) - 6.622;

            // UTC time
            let UTRise = TRise - lngHour;
            let UTSet = TSet - lngHour;
            while (UTRise < 0) UTRise += 24;
            while (UTRise >= 24) UTRise -= 24;
            while (UTSet < 0) UTSet += 24;
            while (UTSet >= 24) UTSet -= 24;

            // Convert to EST (UTC-5)
            let localRise = UTRise - 5;
            let localSet = UTSet - 5;
            if (localRise < 0) localRise += 24;
            if (localSet < 0) localSet += 24;

            function formatTime(t) {
                const h = Math.floor(t);
                const m = Math.round((t - h) * 60);
                return `${h}:${m.toString().padStart(2, '0')}`;
            }

            return { sunrise: formatTime(localRise), sunset: formatTime(localSet) };
        }

        function renderWeather(year, month, day) {
            const widget = document.getElementById('weather-widget');
            const el = document.getElementById('weather-content');

            try {
                const d = weatherData?.black_mountain_college_weather_archive?.years?.[year]?.months?.[month]?.days?.[day]?.daily;
                if (!d) { widget.style.display = 'none'; return; }

                widget.style.display = 'flex';
                const desc = weatherCodes[d.weather_code] || '';
                const sun = getSunTimes(parseInt(year), parseInt(month), parseInt(day));

                el.innerHTML = `
                    <div class="weather-item">
                        <div class="weather-value">${d.temperature_2m_min}°–${d.temperature_2m_max}°</div>
                        <div class="weather-label">Temp (°C)</div>
                    </div>
                    <div class="weather-item">
                        <div class="weather-value">${d.precipitation_sum}</div>
                        <div class="weather-label">Precip (mm)</div>
                    </div>
                    <div class="weather-item">
                        <div class="weather-value">${sun.sunrise}</div>
                        <div class="weather-label">Sunrise</div>
                    </div>
                    <div class="weather-item">
                        <div class="weather-value">${sun.sunset}</div>
                        <div class="weather-label">Sunset</div>
                    </div>
                    ${desc ? `<div class="weather-desc">${desc}</div>` : ''}
                `;
            } catch (e) { widget.style.display = 'none'; }
        }

        function isPersonPresentOnDate(data, dateKey) {
            // Check if person was present on specific date
            // dateKey format: "YYYY-MM-DD"

            // If person has periods array (for guest faculty with multiple visits)
            if (data.periods && Array.isArray(data.periods)) {
                for (const period of data.periods) {
                    if (dateKey >= period.start && dateKey <= period.end) {
                        return true;
                    }
                }
                return false;
            }

            // If person has precise start_date and end_date
            if (data.start_date && data.end_date) {
                return dateKey >= data.start_date && dateKey <= data.end_date;
            }

            // Fall back to year-based check
            const yearNum = parseInt(dateKey.substring(0, 4));
            const startYear = data.start_year || 9999;
            const endYear = data.end_year || 0;
            return yearNum >= startYear && yearNum <= endYear;
        }

        function renderPeople(year, dateKey) {
            const widget = document.getElementById('people-widget');
            const el = document.getElementById('people-content');
            const total = document.getElementById('people-total');

            try {
                const facultyMap = new Map();
                const studentsMap = new Map();
                const staffMap = new Map();
                const guestsMap = new Map();
                const familyMap = new Map();
                const summerFacultyMap = new Map();
                const summerStudentsMap = new Map();

                // Get month from dateKey to check for summer (June-September = 06-09)
                const month = parseInt(dateKey.split('-')[1]);
                const isSummerMonth = month >= 6 && month <= 9;

                // Get people from peopleIndex (verified data)
                for (const [name, data] of Object.entries(peopleIndex)) {
                    // Use precise date checking
                    if (!isPersonPresentOnDate(data, dateKey)) {
                        continue;
                    }

                    const person = { name, ...data };
                    const role = (data.role || '').toLowerCase();

                    // Classify by role - check Summer first (only show in summer months)
                    if (role.includes('summer') && role.includes('faculty')) {
                        if (isSummerMonth) summerFacultyMap.set(name, person);
                    } else if (role.includes('summer') && role.includes('student')) {
                        if (isSummerMonth) summerStudentsMap.set(name, person);
                    } else if (role.includes('summer')) {
                        if (isSummerMonth) summerFacultyMap.set(name, person);
                    } else if (role.includes('faculty') || role.includes('admin')) {
                        facultyMap.set(name, person);
                    } else if (role.includes('student')) {
                        studentsMap.set(name, person);
                    } else if (role.includes('staff')) {
                        staffMap.set(name, person);
                    } else if (role.includes('guest')) {
                        guestsMap.set(name, person);
                    } else if (role.includes('family')) {
                        familyMap.set(name, person);
                    } else {
                        guestsMap.set(name, person);
                    }
                }

                const faculty = Array.from(facultyMap.values()).sort((a, b) => a.name.localeCompare(b.name));
                const students = Array.from(studentsMap.values()).sort((a, b) => a.name.localeCompare(b.name));
                const staff = Array.from(staffMap.values()).sort((a, b) => a.name.localeCompare(b.name));
                const guests = Array.from(guestsMap.values()).sort((a, b) => a.name.localeCompare(b.name));
                const family = Array.from(familyMap.values()).sort((a, b) => a.name.localeCompare(b.name));
                const summerFaculty = Array.from(summerFacultyMap.values()).sort((a, b) => a.name.localeCompare(b.name));
                const summerStudents = Array.from(summerStudentsMap.values()).sort((a, b) => a.name.localeCompare(b.name));

                if (faculty.length === 0 && students.length === 0 && summerFaculty.length === 0 && summerStudents.length === 0) {
                    widget.style.display = 'none';
                    return;
                }

                widget.style.display = 'flex';
                const totalCount = faculty.length + students.length + staff.length + guests.length + family.length + summerFaculty.length + summerStudents.length;
                total.textContent = totalCount + ' people';

                el.innerHTML = `
                    ${faculty.length > 0 ? createPeopleDropdown('Faculty', faculty, true) : ''}
                    ${students.length > 0 ? createPeopleDropdown('Students', students, false) : ''}
                    ${summerFaculty.length > 0 ? createPeopleDropdown('Summer Faculty', summerFaculty, false) : ''}
                    ${summerStudents.length > 0 ? createPeopleDropdown('Summer Students', summerStudents, false) : ''}
                    ${staff.length > 0 ? createPeopleDropdown('Staff', staff, false) : ''}
                    ${guests.length > 0 ? createPeopleDropdown('Guests', guests, false) : ''}
                    ${family.length > 0 ? createPeopleDropdown('Family', family, false) : ''}
                `;

                el.querySelectorAll('.dropdown-header').forEach(header => {
                    header.addEventListener('click', () => {
                        header.parentElement.classList.toggle('open');
                    });
                });
            } catch (e) {
                console.error(e);
                widget.style.display = 'none';
            }
        }

        function getAcademicYear(year, month) {
            // Academic year runs Sept-Aug
            // e.g., Sept 1933 = "1933-1934", Jan 1934 = "1933-1934"
            if (month >= 9) {
                return `${year}-${year + 1}`;
            } else {
                return `${year - 1}-${year}`;
            }
        }

        function createPeopleDropdown(title, people, showDetails) {
            const namesList = people.map(p => {
                let details = '';
                if (showDetails && p.title) {
                    details = ` <span class="person-focus">${esc(p.title)}</span>`;
                } else if (p.focus) {
                    details = ` <span class="person-focus">(${esc(p.focus)})</span>`;
                } else if (p.department) {
                    details = ` <span class="person-focus">${esc(p.department)}</span>`;
                }
                return `<div class="person-item">${esc(p.name)}${details}</div>`;
            }).join('');

            return `
                <div class="dropdown">
                    <div class="dropdown-header">
                        <span class="dropdown-title">
                            <span class="dropdown-count">${people.length}</span>
                            ${title}
                        </span>
                        <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="dropdown-content">
                        <div class="people-list">${namesList}</div>
                    </div>
                </div>
            `;
        }

        function createDropdown(title, count, names) {
            const namesList = names && names.length > 0
                ? `<div class="people-list">${names.map(n => `<div class="person-item">${esc(n)}</div>`).join('')}</div>`
                : '<div style="color: var(--text-lighter); font-style: italic;">Full list not available</div>';

            return `
                <div class="dropdown">
                    <div class="dropdown-header">
                        <span class="dropdown-title">
                            <span class="dropdown-count">${count}</span>
                            ${title}
                        </span>
                        <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="dropdown-content">${namesList}</div>
                </div>
            `;
        }

        function renderCourses(year, month) {
            const widget = document.getElementById('courses-widget');
            const el = document.getElementById('courses-content');
            const countEl = document.getElementById('courses-count');

            try {
                const yearNum = parseInt(year);
                const m = parseInt(month);
                const academicYear = getAcademicYear(yearNum, m);
                // Also try short format (1943-44 instead of 1943-1944)
                const academicYearShort = academicYear.replace(/-(\d{2})\d{2}$/, '-$1');
                const semester = m >= 9 ? 'Fall' : m >= 6 ? 'Summer' : 'Spring';

                // Get verified courses (try both long and short format keys)
                let verifiedCourses = verifiedData?.academic_years?.[academicYear]?.courses;
                if (!verifiedCourses || verifiedCourses.length === 0) {
                    verifiedCourses = verifiedData?.academic_years?.[academicYearShort]?.courses;
                }

                // Get unverified courses
                const unverifiedCourses = coursesData?.[year] || [];

                // Check data quality: count courses with instructors
                const verifiedWithInstructors = verifiedCourses?.filter(c => c.instructor)?.length || 0;
                const unverifiedWithInstructors = unverifiedCourses.filter(c => c.instructor).length;

                // Prefer source with more instructor info, fallback to more courses
                let courses, isVerified;
                if (verifiedWithInstructors > 0 && verifiedWithInstructors >= unverifiedWithInstructors) {
                    courses = verifiedCourses;
                    isVerified = true;
                } else if (unverifiedWithInstructors > 0) {
                    courses = unverifiedCourses;
                    isVerified = false;
                } else if (verifiedCourses && verifiedCourses.length >= unverifiedCourses.length) {
                    courses = verifiedCourses;
                    isVerified = true;
                } else {
                    courses = unverifiedCourses;
                    isVerified = false;
                }

                if (!courses || courses.length === 0) { widget.style.display = 'none'; return; }

                widget.style.display = 'flex';
                const verifiedLabel = isVerified ? ' (Dreier)' : '';
                countEl.textContent = `${semester} — ${courses.length}${verifiedLabel}`;

                // Group by department
                const byDept = {};
                courses.forEach(c => {
                    const dept = c.department || 'General';
                    if (!byDept[dept]) byDept[dept] = [];
                    byDept[dept].push(c);
                });

                // Sort departments alphabetically
                const sortedDepts = Object.keys(byDept).sort();

                let html = '';
                for (const dept of sortedDepts) {
                    const deptCourses = byDept[dept];
                    const courseChips = deptCourses.map(c => {
                        const instructor = c.instructor ? getLastName(c.instructor) : '';
                        const instructorHtml = instructor ? ` <span class="course-instructor">(${esc(instructor)})</span>` : '';
                        return `<span class="course-chip">${esc(c.name)}${instructorHtml}</span>`;
                    }).join('');

                    html += `
                        <div class="dropdown">
                            <div class="dropdown-header">
                                <span class="dropdown-title">
                                    <span class="dropdown-count">${deptCourses.length}</span>
                                    ${esc(dept)}
                                </span>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            <div class="dropdown-content">
                                <div class="courses-grid">${courseChips}</div>
                            </div>
                        </div>
                    `;
                }

                el.innerHTML = html;

                el.querySelectorAll('.dropdown-header').forEach(header => {
                    header.addEventListener('click', () => {
                        header.parentElement.classList.toggle('open');
                    });
                });
            } catch (e) { widget.style.display = 'none'; }
        }

        function renderEvents(year, dateKey) {
            const widget = document.getElementById('events-widget');
            const el = document.getElementById('events-content');
            const countEl = document.getElementById('events-count');

            try {
                const events = archiveData?.daily_calendar?.[year]?.[dateKey]?.bmc_events;
                if (!events || events.length === 0) { widget.style.display = 'none'; return; }

                widget.style.display = 'flex';
                countEl.textContent = events.length;

                // Group by category
                const byCategory = {};
                events.forEach(e => {
                    const cat = e.category || 'other';
                    if (!byCategory[cat]) byCategory[cat] = [];
                    byCategory[cat].push(e);
                });

                const catLabels = {
                    'performance': 'Performances', 'academic': 'Academic', 'meeting': 'Meetings',
                    'arrival': 'Arrivals', 'departure': 'Departures', 'hiring': 'Faculty',
                    'farm': 'Farm', 'construction': 'Construction', 'education': 'Education',
                    'financial': 'Financial', 'administrative': 'Administrative', 'other': 'Other'
                };

                let html = '';
                for (const [cat, catEvents] of Object.entries(byCategory)) {
                    html += `<div class="event-group">`;
                    html += `<div class="event-group-title">${catLabels[cat] || cat}</div>`;
                    catEvents.forEach(e => {
                        const people = e.people ? e.people.slice(0, 4).join(', ') : '';
                        html += `<div class="event-item">`;
                        html += `<div class="event-text">${esc(e.event)}</div>`;
                        if (e.quote) html += `<div class="event-quote">"${esc(e.quote)}"</div>`;
                        if (people) {
                            html += `<div class="event-meta"><span class="event-people">${esc(people)}</span></div>`;
                        }
                        html += `</div>`;
                    });
                    html += `</div>`;
                }

                el.innerHTML = html;
            } catch (e) { widget.style.display = 'none'; }
        }

        function formatSource(source, location, certainty) {
            if (!source) return '';

            let citation = '';

            // Already formatted ISO 690 citation (starts with AUTHOR NAME in caps)
            if (source.match(/^[A-Z]{2,},\s/)) {
                citation = source;
            }
            // Duberman book references (Page XX or p. XX)
            else if (source.match(/^Page \d+/i) || source.match(/Duberman.*p\.\s*\d+/i)) {
                const pageNum = source.match(/\d+/)[0];
                citation = `Duberman p. ${pageNum}`;
            }
            // Farm PDF from Dreier Collection
            else if (source.includes('farm_low.pdf')) {
                const pageMatch = source.match(/pages? (\d+)(?:-(\d+))?/i);
                const pages = pageMatch ? (pageMatch[2] ? `p. ${pageMatch[1]}-${pageMatch[2]}` : `p. ${pageMatch[1]}`) : '';
                citation = `Dreier Collection${pages ? ', ' + pages : ''}`;
            }
            // Harris interviews
            else if (source.includes('Harris interview') || source.includes('Harris Papers')) {
                const nameMatch = source.match(/with ([^(,]+)/);
                const interviewee = nameMatch ? nameMatch[1].trim() : '';
                citation = `Harris interview${interviewee ? ' (' + interviewee + ')' : ''}`;
            }
            // Rollins Archives
            else if (source.includes('Rollins')) {
                citation = `Rollins College Archives`;
            }
            // Asheville/Dreier Collection
            else if (source.match(/asheville|Dreier/i) || source.match(/^\d{4}_/)) {
                const objectId = source.match(/(\d{4}[_\.][^,\s]+)/);
                const idStr = objectId ? ` ${objectId[1]}` : '';
                citation = `Dreier Collection${idStr}`;
            }
            // Keep original source as-is (don't invent citations)
            else {
                citation = source;
            }

            let html = `<span class="event-source">${esc(citation)}</span>`;

            // Add certainty indicator if available
            if (certainty && certainty < 80) {
                html += ` <span class="certainty-low" title="Certitude: ${certainty}%">~</span>`;
            }

            return html;
        }

        function renderNational(year, dateKey) {
            const widget = document.getElementById('national-widget');
            const el = document.getElementById('national-content');
            const countEl = document.getElementById('national-count');

            try {
                // Get events from national data (Asheville, NC, Congress, National)
                const nationalEvents = nationalData?.events?.[dateKey] || [];

                // Get events from precise chronology (USA)
                const chronoEvents = chronologyData?.events?.[dateKey]?.usa || [];

                // Also get from archive (legacy data)
                const archiveEvents = (archiveData?.daily_calendar?.[year]?.[dateKey]?.world_events || [])
                    .filter(e => e.category === 'usa');

                // Get NYT national headlines for this date
                const nytEvents = (nytNationalData || [])
                    .filter(h => h.date === dateKey)
                    .map(h => ({
                        event: h.title,
                        category: 'nyt',
                        source: 'NY Times',
                        url: h.url
                    }));

                // Merge all, avoiding duplicates
                const events = [...nationalEvents];
                chronoEvents.forEach(e => {
                    if (!events.some(ce => ce.event === e.event)) {
                        events.push({...e, category: 'national'});
                    }
                });
                archiveEvents.forEach(e => {
                    if (!events.some(ce => ce.event === e.event)) {
                        events.push({...e, category: 'national'});
                    }
                });
                // Add NYT at the end
                nytEvents.forEach(e => events.push(e));

                // Sort by category priority: asheville, north_carolina, congress, national, nyt
                const categoryOrder = { asheville: 0, north_carolina: 1, congress: 2, national: 3, nyt: 4 };
                events.sort((a, b) => (categoryOrder[a.category] || 3) - (categoryOrder[b.category] || 3));

                widget.style.display = 'flex';
                countEl.textContent = events.length || '';

                if (events.length === 0) {
                    el.innerHTML = '<div class="no-events">No national events recorded for this date</div>';
                } else {
                    el.innerHTML = events.map(e => renderNationalEvent(e, dateKey)).join('');
                }
            } catch (e) { widget.style.display = 'flex'; el.innerHTML = '<div class="no-events">No national events recorded for this date</div>'; }
        }

        function formatEventDate(dateKey) {
            const [year, month, day] = dateKey.split('-');
            const monthShort = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${monthShort[parseInt(month) - 1]} ${parseInt(day)}, ${year}`;
        }

        function renderNationalEvent(e, startDate) {
            const categoryLabel = {
                asheville: 'Asheville',
                north_carolina: 'NC',
                congress: 'Congress',
                national: 'USA',
                nyt: 'NYT'
            };
            const categoryBadge = e.category ?
                `<span class="category-badge ${esc(e.category)}">${categoryLabel[e.category] || e.category}</span>` : '';
            const dateTag = `<span class="event-date">${formatEventDate(startDate)}</span>`;
            const topicTag = e.topic ? `<span class="context-tag ${esc(e.topic)}">${esc(e.topic)}</span>` : '';
            const locationTag = e.location ? `<span>${esc(e.location)}</span>` : '';
            const sourceTag = e.source ? `<span class="event-source">${esc(e.source)}</span>` : '';

            // Duration display
            let durationTag = '';
            if (e.end_date) {
                const start = new Date(startDate);
                const end = new Date(e.end_date);
                const days = Math.round((end - start) / (1000 * 60 * 60 * 24));
                if (days > 365) {
                    const years = Math.round(days / 365 * 10) / 10;
                    durationTag = `<span class="event-duration">→ ${formatEventDate(e.end_date)} (${years} years)</span>`;
                } else if (days > 30) {
                    const months = Math.round(days / 30);
                    durationTag = `<span class="event-duration">→ ${formatEventDate(e.end_date)} (${months} months)</span>`;
                } else {
                    durationTag = `<span class="event-duration">→ ${formatEventDate(e.end_date)} (${days} days)</span>`;
                }
            }

            const eventText = e.url ?
                `<a href="${esc(e.url)}" target="_blank" class="event-link">${esc(e.event)}</a>` :
                esc(e.event);

            return `<div class="context-event">
                <div class="context-event-title">${dateTag}${categoryBadge}${eventText}</div>
                ${e.description ? `<div class="context-event-desc">${esc(e.description)}</div>` : ''}
                <div class="context-event-meta">
                    ${topicTag}${durationTag}${locationTag}${sourceTag}
                </div>
            </div>`;
        }

        function renderWorld(year, dateKey) {
            const widget = document.getElementById('world-widget');
            const el = document.getElementById('world-content');
            const countEl = document.getElementById('world-count');

            try {
                // Get events from precise chronology
                const chronoEvents = chronologyData?.events?.[dateKey]?.world || [];

                // Also get from archive (legacy data)
                const archiveEvents = (archiveData?.daily_calendar?.[year]?.[dateKey]?.world_events || [])
                    .filter(e => e.category === 'world' || e.category === 'international');

                // Get NYT international headlines for this date
                const nytEvents = (nytInternationalData || [])
                    .filter(h => h.date === dateKey)
                    .map(h => ({
                        event: h.title,
                        source: 'NY Times',
                        url: h.url
                    }));

                // Merge, avoiding duplicates
                const events = [...chronoEvents];
                archiveEvents.forEach(e => {
                    if (!events.some(ce => ce.event === e.event)) {
                        events.push(e);
                    }
                });
                // Add NYT at the end
                nytEvents.forEach(e => events.push(e));

                widget.style.display = 'flex';
                countEl.textContent = events.length || '';

                if (events.length === 0) {
                    el.innerHTML = '<div class="no-events">No international events recorded for this date</div>';
                } else {
                    el.innerHTML = events.map(e => renderContextEvent(e, dateKey)).join('');
                }
            } catch (e) { widget.style.display = 'flex'; el.innerHTML = '<div class="no-events">No international events recorded for this date</div>'; }
        }

        function renderContextEvent(e, startDate) {
            const dateTag = `<span class="event-date">${formatEventDate(startDate)}</span>`;
            const topicTag = e.topic ? `<span class="context-tag ${esc(e.topic)}">${esc(e.topic)}</span>` : '';
            const locationTag = e.location ? `<span>${esc(e.location)}</span>` : '';
            const sourceTag = e.source ? `<span class="event-source">${esc(e.source)}</span>` : '';

            // Duration display
            let durationTag = '';
            if (e.end_date) {
                const start = new Date(startDate);
                const end = new Date(e.end_date);
                const days = Math.round((end - start) / (1000 * 60 * 60 * 24));
                if (days > 365) {
                    const years = Math.round(days / 365 * 10) / 10;
                    durationTag = `<span class="event-duration">→ ${formatEventDate(e.end_date)} (${years} years)</span>`;
                } else if (days > 30) {
                    const months = Math.round(days / 30);
                    durationTag = `<span class="event-duration">→ ${formatEventDate(e.end_date)} (${months} months)</span>`;
                } else {
                    durationTag = `<span class="event-duration">→ ${formatEventDate(e.end_date)} (${days} days)</span>`;
                }
            }

            const eventText = e.url ?
                `<a href="${esc(e.url)}" target="_blank" class="event-link">${esc(e.event)}</a>` :
                esc(e.event);

            return `<div class="context-event">
                <div class="context-event-title">${dateTag}${eventText}</div>
                ${e.description ? `<div class="context-event-desc">${esc(e.description)}</div>` : ''}
                <div class="context-event-meta">
                    ${topicTag}${durationTag}${locationTag}${sourceTag}
                </div>
            </div>`;
        }

        function renderCulture(year, month, day) {
            const widget = document.getElementById('culture-widget');
            const el = document.getElementById('culture-content');
            const countEl = document.getElementById('culture-count');

            try {
                const dateKey = `${year}-${month}-${day}`;
                const selectedDate = new Date(dateKey);

                // Collect all culture events with their dates
                const events = [];

                // Get from precise chronology
                if (chronologyData?.events) {
                    for (const [evtDate, data] of Object.entries(chronologyData.events)) {
                        if (data.culture) {
                            data.culture.forEach(e => {
                                const startDate = new Date(evtDate);
                                const endDate = e.end_date ? new Date(e.end_date) : startDate;
                                if (selectedDate >= startDate && selectedDate <= endDate) {
                                    if (!events.some(ce => ce.title === e.title)) {
                                        events.push({ ...e, eventDate: evtDate });
                                    }
                                }
                            });
                        }
                    }
                }

                // Get from culture file (exact dates and check if active)
                if (cultureData?.events) {
                    for (const [evtDate, evtList] of Object.entries(cultureData.events)) {
                        evtList.forEach(e => {
                            const startDate = new Date(evtDate);
                            const endDate = e.end_date ? new Date(e.end_date) : startDate;
                            if (selectedDate >= startDate && selectedDate <= endDate) {
                                if (!events.some(ce => ce.title === e.title)) {
                                    events.push({ ...e, eventDate: evtDate });
                                }
                            }
                        });
                    }
                }

                // Get NYT culture headlines for this date
                const nytEvents = (nytCultureData || [])
                    .filter(h => h.date === dateKey)
                    .map(h => ({
                        title: h.title,
                        type: 'nyt',
                        eventDate: dateKey,
                        url: h.url
                    }));
                nytEvents.forEach(e => events.push(e));

                widget.style.display = 'flex';
                countEl.textContent = events.length || '';

                if (events.length === 0) {
                    el.innerHTML = '<div class="no-events">No cultural events recorded for this date</div>';
                    return;
                }

                el.innerHTML = events.map(e => {
                    const typeLabels = { film: 'Film', book: 'Book', theater: 'Theater', concert: 'Concert', art: 'Art', nyt: 'NYT' };
                    const typeLabel = typeLabels[e.type] || e.type || '';

                    // Date display
                    const dateTag = e.eventDate ? `<span class="event-date">${formatEventDate(e.eventDate)}</span>` : '';

                    // Duration for exhibitions, etc.
                    let durationTag = '';
                    if (e.end_date && e.eventDate) {
                        const start = new Date(e.eventDate);
                        const end = new Date(e.end_date);
                        const days = Math.round((end - start) / (1000 * 60 * 60 * 24));
                        if (days > 30) {
                            const months = Math.round(days / 30);
                            durationTag = `<span class="event-duration">→ ${formatEventDate(e.end_date)} (${months} months)</span>`;
                        } else if (days > 0) {
                            durationTag = `<span class="event-duration">→ ${formatEventDate(e.end_date)} (${days} days)</span>`;
                        }
                    }

                    // Title with optional URL
                    const titleText = e.url ?
                        `<a href="${esc(e.url)}" target="_blank" class="event-link">${esc(e.title)}</a>` :
                        esc(e.title);

                    return `<div class="culture-item">
                        <div>${dateTag}<span class="culture-type ${esc(e.type || '')}">${typeLabel}</span><span class="culture-title">${titleText}</span></div>
                        ${durationTag ? `<div>${durationTag}</div>` : ''}
                        ${e.creator ? `<div class="culture-creator">${esc(e.creator)}</div>` : ''}
                        ${e.description ? `<div class="culture-desc">${esc(e.description)}</div>` : ''}
                    </div>`;
                }).join('');
            } catch (e) { widget.style.display = 'flex'; el.innerHTML = '<div class="no-events">No cultural events recorded for this date</div>'; }
        }

        function renderRadio(year, month, day) {
            const widget = document.getElementById('radio-widget');
            const el = document.getElementById('radio-content');

            try {
                const songs = radioData?.bmc_radio_archive?.years?.[year]?.months?.[month]?.days?.[day]?.songs;
                if (!songs || songs.length === 0) { widget.style.display = 'none'; return; }

                widget.style.display = 'flex';

                el.innerHTML = songs.slice(0, 6).map(s => `
                    <div class="song-item">
                        <span class="song-prob">${Math.round(s.probability * 100)}%</span>
                        <div class="song-info">
                            <div class="song-title">${esc(s.title)}</div>
                            <div class="song-artist">${esc(s.artist)}</div>
                        </div>
                    </div>
                `).join('');
            } catch (e) { widget.style.display = 'none'; }
        }

        function getLastName(fullName) {
            if (!fullName) return '';
            // Handle multiple instructors separated by comma
            const instructors = fullName.split(',').map(name => {
                const trimmed = name.trim();
                // Remove suffixes like Jr., Sr., II, III, IV, etc.
                const suffixes = /,?\s*(Jr\.?|Sr\.?|II|III|IV|V)$/i;
                const cleaned = trimmed.replace(suffixes, '').trim();
                const parts = cleaned.split(' ');
                return parts[parts.length - 1] || '';
            }).filter(n => n);
            return instructors.join(', ');
        }

        function esc(t) {
            if (!t) return '';
            const d = document.createElement('div');
            d.textContent = t;
            return d.innerHTML;
        }

        document.getElementById('date-picker').addEventListener('change', search);

        // Contact form initialization (mailto approach for static site)
        function initContactForm() {
            const form = document.getElementById('contact-form');
            const status = document.getElementById('contact-status');

            if (!form || !status) return;

            // Email parts (split to avoid scrapers)
            const emailUser = 'retconblackmountain';
            const emailDomain = 'gmail.com';

            form.addEventListener('submit', function(e) {
                e.preventDefault();

                const name = form.querySelector('[name="name"]').value.trim();
                const email = form.querySelector('[name="email"]').value.trim();
                const message = form.querySelector('[name="message"]').value.trim();

                if (!name || !email || !message) {
                    status.textContent = 'Please fill in all fields.';
                    status.className = 'contact-status error';
                    return;
                }

                // Build mailto URL
                const subject = encodeURIComponent('BMC Chronology - Correction from ' + name);
                const body = encodeURIComponent(
                    'From: ' + name + '\n' +
                    'Email: ' + email + '\n\n' +
                    message
                );

                const mailtoUrl = 'mailto:' + emailUser + '@' + emailDomain + '?subject=' + subject + '&body=' + body;

                // Open email client
                window.location.href = mailtoUrl;

                status.textContent = 'Opening your email client...';
                status.className = 'contact-status success';

                // Reset after delay
                setTimeout(() => {
                    form.reset();
                    status.textContent = '';
                }, 3000);
            });
        }

        window.onload = function() {
            initContactForm();
            loadData();
        };
    </script>
</body>
</html>
